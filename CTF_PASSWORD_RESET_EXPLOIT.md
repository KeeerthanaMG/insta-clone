# CTF Vulnerability: Predictable Password Reset Token

## Vulnerability Description
The password reset feature uses a predictable token format that can be exploited to reset other users' passwords.

## How the Vulnerability Works
1. **Token Format**: Instead of secure Django tokens, the app uses: `{uuid}-{base64_username}`
2. **Predictable Pattern**: The base64 part contains the username, making it predictable
3. **Cross-User Exploit**: You can use one user's token format to reset another user's password

## Step-by-Step Exploitation

### Step 1: Create Test Accounts
1. Register two test accounts:
   - User A: `keer` with email `keer@test.com`
   - User B: `alice` with email `alice@test.com`

### Step 2: Request Password Reset for User A
1. Go to: `http://localhost:5173/forgot-password`
2. Enter `keer@test.com` and submit
3. Check the Django server console for the reset link
4. You'll see something like:
   ```
   Reset Link: http://localhost:5173/reset-password/a2Vlcg==/ec50db18-2aac-4f6b-979e-5503f42de984-a2Vlcg==/
   ```

### Step 3: Analyze the Token Format
The URL structure is: `/reset-password/{uidb64}/{token}/`

Where:
- `uidb64` = `a2Vlcg==` (base64 encoded "keer")
- `token` = `ec50db18-2aac-4f6b-979e-5503f42de984-a2Vlcg==`

The token format is: `{uuid}-{base64_username}`
- UUID part: `ec50db18-2aac-4f6b-979e-5503f42de984`
- Base64 username: `a2Vlcg==` (decodes to "keer")

### Step 4: Craft Exploit for User B
1. Encode "alice" in base64: `YWxpY2U=`
2. Create the exploited URL by:
   - Changing `uidb64` to `YWxpY2U=` (alice's username in base64)
   - **Keep the original token** (which contains keer's username)
   - This creates a mismatch: uidb64 says "alice" but token says "keer"

**Exploited URL:**
```
http://localhost:5173/reset-password/YWxpY2U=/ec50db18-2aac-4f6b-979e-5503f42de984-a2Vlcg==/
```

Notice:
- `uidb64` = `YWxpY2U=` (alice)
- `token` = `ec50db18-2aac-4f6b-979e-5503f42de984-a2Vlcg==` (contains keer's username)

### Step 5: Execute the Exploit
1. **Craft the malicious URL** by combining:
   - Alice's `uidb64`: `YWxpY2U=`
   - Keer's `token`: `ec50db18-2aac-4f6b-979e-5503f42de984-a2Vlcg==`
   - **Exploit URL**: `http://localhost:5173/reset-password/YWxpY2U=/ec50db18-2aac-4f6b-979e-5503f42de984-a2Vlcg==/`

2. **Visit the crafted URL** in your browser.

3. **Immediate Detection!** The frontend will call the verification endpoint `/api/auth/password-reset/verify/YWxpY2U=/ec50db18-2aac-4f6b-979e-5503f42de984-a2Vlcg==/`. Since the `uidb64` ("alice") does not match the username in the token ("keer"), the vulnerability is detected instantly.

4. You will not see the password reset form. Instead, a CTF popup will appear.

5. If you are not logged in, the popup will say: "Predictable Password Reset Token bug found! Login to claim your points." You will be redirected to the login page.

6. If you are already logged in (e.g., as `keer`), you will be awarded points immediately, and the popup will show the flag.

### Step 6: Claim CTF Points
1. If you were redirected, log in as the user who generated the token (`keer` in this example).
2. Upon successful login, the system will detect the pending bug discovery from your session.
3. The exploit will be confirmed, and you will be awarded **100 CTF points**.
4. A FlagPopup will appear with the success message and your flag: `CTF{predictable_reset_token_{user_id}}`.

## What Makes This a Security Issue

1. **Predictable Format**: The token format is guessable
2. **Username Leakage**: Base64 encoding is not encryption - usernames are easily decoded
3. **Cross-User Attack**: One user's token pattern can be used against any other user
4. **No Validation**: The system doesn't properly validate token ownership

## Real-World Impact
- Attackers could reset any user's password
- Mass account takeover possible
- No rate limiting on reset attempts
- Tokens are long-lived and reusable

## Proper Implementation
Password reset tokens should be:
- Cryptographically secure random values
- Tied to specific users in the database
- Single-use only
- Time-limited (expire quickly)
- Validated against the intended user

## Current Vulnerability Details
- **Points**: 100 CTF points
- **Detection**: Automatic when username mismatch is detected
- **Flag Format**: `CTF{predictable_reset_token_{user_id}}`
- **Requirement**: Must login after exploit to claim points

## Console Output During Exploit
When you use the exploited URL, you'll see in the verification endpoint:
```
üîç CTF TOKEN VERIFICATION:
üìß User from uidb64: alice
üéØ Username from token: keer
üîó Full token: ec50db18-2aac-4f6b-979e-5503f42de984-a2Vlcg==

üö® CTF BUG DETECTED: Username mismatch!
   Expected (from uidb64): alice
   From token: keer
üéØ CTF discovery stored for session: [session_id]
```

The bug is detected immediately when visiting the URL through the verification endpoint (`/api/auth/password-reset/verify/`), which compares the username from the `uidb64` (alice) with the username embedded in the token (keer). Any mismatch triggers the CTF bug discovery mechanism.

## Technical Implementation

The vulnerability is implemented in:
- `ForgotPasswordView.post()` - Generates predictable tokens
- `PasswordResetVerifyView.get()` - **NEW**: Detects token misuse immediately via GET `/api/auth/password-reset/verify/<uidb64>/<token>/`
- `ResetPasswordView.post()` - Handles actual password resets (fallback detection)
- `LoginView.post()` - Awards points for pending discoveries

### Verification Endpoint
**URL**: `/api/auth/password-reset/verify/<uidb64>/<token>/`  
**Method**: GET  
**Purpose**: Immediately verify if a password reset token has been tampered with

**Response for vulnerability detected (authenticated user)**:
```json
{
  "vulnerability_detected": true,
  "bug_title": "Predictable Password Reset Token",
  "ctf_message": "Bug found! +100 points",
  "flag": "CTF{predictable_reset_token_123}",
  "points_awarded": 100,
  "require_login": false
}
```

**Response for vulnerability detected (unauthenticated user)**:
```json
{
  "vulnerability_detected": true,
  "bug_title": "Predictable Password Reset Token", 
  "ctf_message": "Predictable Password Reset Token bug found! Login to claim your points.",
  "require_login": true
}
```

**Response for valid token**:
```json
{
  "vulnerability_detected": false,
  "valid": true
}
```

## Frontend Integration Required

To complete the implementation, you need to add these changes:

### 1. URL Route (backend/core/urls.py)
```python
path('auth/password-reset/verify/<str:uidb64>/<str:token>/', views.PasswordResetVerifyView.as_view(), name='password-reset-verify'),
```

### 2. Frontend Verification (ResetPasswordPage.jsx)
```javascript
useEffect(() => {
  const verifyToken = async () => {
    try {
      const response = await fetch(`/api/auth/password-reset/verify/${uidb64}/${token}/`);
      const data = await response.json();
      
      if (data.vulnerability_detected) {
        // Trigger CTF popup
        window.dispatchEvent(new CustomEvent('ctf-bug-found', {
          detail: {
            bugTitle: data.bug_title,
            message: data.ctf_message,
            flag: data.flag || null,
            pointsAwarded: data.points_awarded || 0
          }
        }));
        
        // Redirect based on authentication status
        if (data.require_login) {
          navigate('/login');
        } else {
          navigate('/feed');
        }
        return;
      }
      
      // Token is valid, show reset form
      setShowResetForm(true);
    } catch (error) {
      console.error('Token verification failed:', error);
    }
  };
  
  verifyToken();
}, [uidb64, token]);
```

---

**Note**: This is an intentional vulnerability for educational purposes. Never implement such systems in production!
